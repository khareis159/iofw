<!-- 
    COPYRIGHT: © 2026 Carlos Alberto Reis 
    PROJECT: Faculdade Simbiótica HyperWeb3 
    VERSION: 3.1 (Rescue & Stable)
    STATUS: Fixing Black Screen / Data Cleanup
-->
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OESD | Faculdade Simbiótica</title>
    
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- UI Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { background-color: #010409; color: #c9d1d9; font-family: 'Space Grotesk', sans-serif; margin: 0; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .border-oesd { border: 1px solid #30363d; background: #0d1117; transition: all 0.3s ease; }
        .border-oesd:hover { border-color: #238636; box-shadow: 0 0 15px rgba(35, 134, 54, 0.1); }
        
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #238636; border-radius: 2px; }
        
        .stats-bar { height: 4px; border-radius: 2px; background: #21262d; overflow: hidden; }
        .stats-fill { height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .bg-grid { background-image: linear-gradient(to right, #111 1px, transparent 1px), linear-gradient(to bottom, #111 1px, transparent 1px); background-size: 50px 50px; }
        
        .publish-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        /* Error Box */
        #error-trap { display: none; padding: 20px; color: red; background: #1a0000; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; border-bottom: 1px solid red; font-family: monospace; }
    </style>
</head>
<body>
    <div id="error-trap"></div>
    <div id="root"></div>

    <script>
        // --- 0. SEGURANÇA CONTRA TELA PRETA ---
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-trap').style.display = 'block';
            document.getElementById('error-trap').innerHTML = `<strong>⚠️ CRASH DO SISTEMA:</strong> ${msg}<br><small>${url} : ${line}</small><br><br><button onclick="localStorage.clear();location.reload()" style="background:white;color:black;padding:5px;cursor:pointer">LIMPAR MEMÓRIA E REINICIAR</button>`;
            return false;
        };
    </script>

    <script type="text/babel">
        // --- 1. CONFIGURAÇÃO ---
        const DATABASE_URL = "https://khareisbook-default-rtdb.firebaseio.com/"; 
        const COUNTER_URL = DATABASE_URL + "contador_v2.json";
        const CHAVE_IA = "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"; 

        const { useState, useEffect, useRef } = React;

        // Função auxiliar de quebra de texto (fora do componente para evitar hoisting issues)
        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            var words = text.split(' ');
            var line = '';
            for(var n = 0; n < words.length; n++) {
                var testLine = line + words[n] + ' ';
                var metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else { line = testLine; }
            }
            ctx.fillText(line, x, y);
        }

        function App() {
            // Inicializa estados com proteção contra nulos
            const [alunoID, setAlunoID] = useState(localStorage.getItem('alunoID') || "");
            const [nomeInput, setNomeInput] = useState("");
            
            // Stats seguros (evita NaN)
            const [stats, setStats] = useState({ rigor: 10, imaginacao: 10, simbiose: 10 });
            
            const [mensagens, setMensagens] = useState([]);
            const [input, setInput] = useState("");
            const [carregando, setCarregando] = useState(false);
            const [publicando, setPublicando] = useState(false);
            const [visits, setVisits] = useState(1000);
            const chatRef = useRef(null);

            // --- SYNC VISITAS ---
            useEffect(() => {
                fetch(COUNTER_URL).then(r=>r.json()).then(val => {
                    let n = (!val || isNaN(val)) ? 1000 : Number(val);
                    if(!sessionStorage.getItem('kb_sync_v2')) {
                        n++;
                        fetch(COUNTER_URL, {method:'PUT', body:String(n)});
                        sessionStorage.setItem('kb_sync_v2', 'true');
                    }
                    setVisits(n);
                }).catch(()=>setVisits(1000));
            }, []);

            // --- CARREGAR DADOS ---
            useEffect(() => {
                if (alunoID) {
                    // Carrega stats com fallback
                    fetch(`${DATABASE_URL}pioneiros/${alunoID}/stats.json`)
                        .then(r => r.json()).then(d => {
                            if(d && typeof d.rigor === 'number') setStats(d);
                            else setStats({ rigor: 10, imaginacao: 10, simbiose: 10 });
                        });
                    
                    // Carrega histórico
                    fetch(`${DATABASE_URL}pioneiros/${alunoID}/historico.json`)
                        .then(r => r.json()).then(d => {
                            if(d) setMensagens(Object.values(d));
                            else setMensagens([{ autor: 'Tutor', texto: `Bem-vindo à Forja, ${alunoID}. OESD Ativo.` }]);
                        });
                    
                    localStorage.setItem('alunoID', alunoID);
                }
            }, [alunoID]);

            useEffect(() => { chatRef.current?.scrollTo(0, chatRef.current.scrollHeight); }, [mensagens]);

            // --- CHAT ENGINE ---
            const enviar = async () => {
                if (!input || carregando) return;
                const txt = input; setInput(""); setCarregando(true);

                const msgUser = { autor: alunoID, texto: txt, timestamp: Date.now() };
                setMensagens(p => [...p, msgUser]);
                fetch(`${DATABASE_URL}pioneiros/${alunoID}/historico.json`, { method:'POST', body:JSON.stringify(msgUser) });

                try {
                    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${CHAVE_IA.trim()}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "llama-3.1-8b-instant",
                            messages: [{role:"system",content:"Tutor OESD. Breve e acadêmico."}, {role:"user",content:txt}]
                        })
                    });
                    const data = await res.json();
                    const resp = data.choices[0].message.content;
                    const msgIA = { autor: 'Tutor', texto: resp, timestamp: Date.now() };

                    setMensagens(p => [...p, msgIA]);
                    fetch(`${DATABASE_URL}pioneiros/${alunoID}/historico.json`, { method:'POST', body:JSON.stringify(msgIA) });

                    // Stats Seguros
                    setStats(prev => {
                        const next = {
                            rigor: Math.min(prev.rigor + 2, 100),
                            imaginacao: Math.min(prev.imaginacao + 2, 100),
                            simbiose: Math.min(Math.round(((prev.rigor+2)+(prev.imaginacao+2))/2), 100)
                        };
                        fetch(`${DATABASE_URL}pioneiros/${alunoID}/stats.json`, { method:'PUT', body:JSON.stringify(next) });
                        return next;
                    });

                } catch (e) { console.error(e); } finally { setCarregando(false); }
            };

            // --- PUBLICADOR ---
            const publicarNaBiblioteca = async () => {
                const titulo = prompt("Defina o Título da Obra:");
                if (!titulo) return;
                setPublicando(true);

                try {
                    // Canvas Generator
                    const canvas = document.createElement('canvas');
                    canvas.width = 400; canvas.height = 600;
                    const ctx = canvas.getContext('2d');
                    
                    const grd = ctx.createLinearGradient(0, 0, 0, 600);
                    grd.addColorStop(0, "#010409"); grd.addColorStop(1, "#0d1117");
                    ctx.fillStyle = grd; ctx.fillRect(0,0,400,600);
                    
                    ctx.strokeStyle = "#238636"; ctx.lineWidth = 8;
                    ctx.strokeRect(15, 15, 370, 570);
                    
                    ctx.fillStyle = "#ffffff"; ctx.textAlign = "center";
                    ctx.font = "bold 28px monospace";
                    wrapText(ctx, titulo.toUpperCase(), 200, 200, 300, 35);
                    
                    ctx.fillStyle = "#238636"; ctx.font = "bold 18px sans-serif";
                    ctx.fillText("FACULDADE ÍNTEGRA", 200, 450);
                    
                    ctx.fillStyle = "#8b949e"; ctx.font = "italic 16px serif";
                    ctx.fillText(`Pioneiro: ${alunoID}`, 200, 500);

                    const capa = canvas.toDataURL("image/jpeg", 0.7);

                    const payload = {
                        title: titulo,
                        author: alunoID,
                        category: "artigos",
                        desc: `Trabalho acadêmico gerado na Forja OESD.`,
                        cover: capa,
                        price: 0, salePrice: 0, plan: "padrao",
                        origin: "iofw_student",
                        link: "https://khareis159.github.io/iofw/",
                        status: 'pending',
                        createdAt: Date.now()
                    };

                    await fetch(`${DATABASE_URL}shelf.json`, { method:'POST', body:JSON.stringify(payload) });
                    alert("✅ Publicado na Biblioteca KhareisBook (Pendente de Aprovação)");
                } catch(e) {
                    alert("Erro na publicação: " + e.message);
                } finally { setPublicando(false); }
            };

            const limparDados = () => {
                if(confirm("Apagar seu progresso local?")) {
                    localStorage.clear();
                    location.reload();
                }
            };

            if (!alunoID) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-[#010409]">
                        <div className="border-oesd p-10 rounded-2xl max-w-md w-full text-center">
                            <h1 className="text-3xl font-bold mb-2 text-[#238636] mono">OESD // LOGIN</h1>
                            <input value={nomeInput} onChange={e => setNomeInput(e.target.value)} className="w-full bg-black border border-[#30363d] p-4 rounded-lg my-6 text-white text-center outline-none focus:border-[#238636]" placeholder="IDENTIFICAÇÃO" />
                            <button onClick={() => nomeInput && setAlunoID(nomeInput.trim())} className="w-full bg-[#238636] text-white py-4 rounded font-bold hover:bg-[#2ea043]">INICIAR</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen flex flex-col md:flex-row text-gray-300 font-sans">
                    <aside className="w-full md:w-80 bg-[#0d1117] border-r border-[#30363d] p-6 flex flex-col">
                        <div className="mb-8"><h1 className="text-xl font-bold text-white mono">FACULDADE <span className="text-[#238636]">ÍNTEGRA</span></h1><p className="text-xs uppercase mt-1">{alunoID}</p></div>
                        <div className="space-y-4 mb-8">
                            <div><div className="flex justify-between text-xs mb-1 font-bold">RIGOR</div><div className="stats-bar"><div className="stats-fill bg-[#238636]" style={{width:`${stats.rigor}%`}}></div></div></div>
                            <div><div className="flex justify-between text-xs mb-1 font-bold">IMAGINAÇÃO</div><div className="stats-bar"><div className="stats-fill bg-[#8957e5]" style={{width:`${stats.imaginacao}%`}}></div></div></div>
                            <div className="text-center pt-4 border-t border-[#30363d]"><span className="text-xs uppercase block mb-1">Simbiose</span><span className="text-3xl font-bold text-white">{stats.simbiose}%</span></div>
                        </div>
                        <div className="mt-auto space-y-2">
                            <button onClick={publicarBiblioteca} className="w-full py-3 bg-[#1f6feb] text-white rounded font-bold text-xs uppercase hover:bg-[#388bfd]">Publicar na Biblioteca</button>
                            <button onClick={() => { localStorage.clear(); location.reload(); }} className="w-full py-2 text-xs text-red-500 uppercase">Sair / Reset</button>
                            <div className="text-center pt-4 text-[10px] text-[#238636]"><i className="fas fa-users"></i> {visits.toLocaleString('pt-BR')} Online</div>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col bg-[#010409] relative">
                        <div ref={chatRef} className="flex-1 overflow-y-auto p-6 space-y-4 chat-scroll bg-grid">
                            {mensagens.map((m, i) => (
                                <div key={i} className={`flex ${m.autor==='Tutor'?'justify-start':'justify-end'}`}>
                                    <div className={`max-w-[85%] p-4 rounded-lg text-sm border ${m.autor==='Tutor'?'bg-[#161b22] border-[#30363d]':'bg-[#23863615] border-[#23863640]'}`}>
                                        <div className="text-[10px] font-bold mb-1 opacity-50 uppercase">{m.autor}</div>
                                        <div className="whitespace-pre-wrap">{m.texto}</div>
                                    </div>
                                </div>
                            ))}
                            {carregando && <div className="text-center text-xs animate-pulse text-[#238636]">...</div>}
                        </div>
                        <div className="p-4 border-t border-[#30363d] bg-[#0d1117] flex gap-2">
                            <input value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&enviar()} className="flex-1 bg-[#010409] border border-[#30363d] rounded p-3 text-white outline-none focus:border-[#238636]" placeholder="Comando..." disabled={carregando} />
                            <button onClick={enviar} disabled={carregando||!input} className="px-6 bg-[#238636] text-white rounded font-bold hover:bg-[#2ea043] disabled:opacity-50">SEND</button>
                        </div>
                        {publicando && <div className="publish-overlay"><div className="text-[#238636] font-mono font-bold bg-black px-4 py-2 border border-[#238636]">ENVIANDO...</div></div>}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
