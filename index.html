<!-- 
    COPYRIGHT: ¬© 2025 Carlos Alberto Reis 
    PROJECT: Faculdade Simbi√≥tica HyperWeb3 
    METHODOLOGY: OESD (Ordem Epistemol√≥gica de Simbiose Digital)
    PHASE: 2 - APP CONSOLIDADO (VERS√ÉO DEPURADA 2.1)
-->
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OESD | Faculdade Simbi√≥tica HyperWeb3</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { background-color: #010409; color: #c9d1d9; font-family: 'Space Grotesk', sans-serif; margin: 0; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .border-oesd { border: 1px solid #30363d; background: #0d1117; transition: all 0.3s ease; }
        .border-oesd:hover { border-color: #238636; box-shadow: 0 0 15px rgba(35, 134, 54, 0.1); }
        .chat-scroll::-webkit-scrollbar { width: 3px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #238636; border-radius: 10px; }
        .stats-bar { height: 4px; border-radius: 2px; background: #21262d; overflow: hidden; }
        .stats-fill { height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .glow-green { text-shadow: 0 0 10px #238636; }
        .bg-grid { background-image: linear-gradient(to right, #111 1px, transparent 1px), linear-gradient(to bottom, #111 1px, transparent 1px); background-size: 50px 50px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const firebaseConfig = { databaseURL: "https://iofw-79391-default-rtdb.firebaseio.com/" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { useState, useEffect, useRef } = React;

        function App() {
            // ============================================================
            // CONFIGURA√á√ÉO: INSIRA SUA CHAVE ABAIXO (MANTENHA AS ASPAS)
            const CHAVE_IA = "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"; 
            // ============================================================

            const [alunoID, setAlunoID] = useState(localStorage.getItem('alunoID') || "");
            const [nomeInput, setNomeInput] = useState("");
            const [stats, setStats] = useState({ rigor: 10, imaginacao: 10, simbiose: 10 });
            const [mensagens, setMensagens] = useState([]);
            const [input, setInput] = useState("");
            const [carregando, setCarregando] = useState(false);
            const chatRef = useRef(null);

            useEffect(() => {
                if (alunoID) {
                    db.ref(`pioneiros/${alunoID}/stats`).on('value', (s) => s.val() && setStats(s.val()));
                    db.ref(`pioneiros/${alunoID}/historico`).on('value', (s) => {
                        const data = s.val();
                        if (data) setMensagens(Object.values(data));
                        else setMensagens([{ autor: 'Tutor', texto: `Bem-vindo, ${alunoID}. A Matriz est√° pronta.` }]);
                    });
                }
            }, [alunoID]);

            useEffect(() => { chatRef.current?.scrollTo(0, chatRef.current.scrollHeight); }, [mensagens]);

            const enviar = async () => {
                if (!input || carregando) return;
                const textoUser = input;
                setInput("");
                setCarregando(true);

                // Salva pergunta do aluno
                db.ref(`pioneiros/${alunoID}/historico`).push({ autor: alunoID, texto: textoUser, timestamp: Date.now() });

                try {
                    if (CHAVE_IA.includes("COLE_AQUI")) throw new Error("Chave IA n√£o configurada na linha 42.");

                    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${CHAVE_IA.trim()}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "llama-3.1-8b-instant",
                            messages: [
                                { role: "system", content: "Voc√™ √© o Tutor Simbi√≥tico OESD. Responda com Rigor Cient√≠fico e Imagina√ß√£o Est√©tica." },
                                { role: "user", content: textoUser }
                            ]
                        })
                    });

                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.error?.message || "Erro na conex√£o");
                    }

                    const data = await res.json();
                    const respostaIA = data.choices[0].message.content;

                    // Salva resposta do Tutor
                    db.ref(`pioneiros/${alunoID}/historico`).push({ autor: 'Tutor', texto: respostaIA, timestamp: Date.now() });

                    // Atualiza√ß√£o segura de Stats
                    db.ref(`pioneiros/${alunoID}/stats`).transaction((curr) => {
                        const r = (curr?.rigor || 10) + 3;
                        const i = (curr?.imaginacao || 10) + 5;
                        return { rigor: Math.min(r, 100), imaginacao: Math.min(i, 100), simbiose: Math.min(Math.round((r + i) / 2), 100) };
                    });

                } catch (e) {
                    db.ref(`pioneiros/${alunoID}/historico`).push({ autor: 'SISTEMA', texto: `‚ö†Ô∏è AVISO: ${e.message}` });
                } finally { setCarregando(false); }
            };

const limparChat = () => {
                if(confirm("Deseja limpar as mensagens e resqu√≠cios do laborat√≥rio?")) {
                    db.ref(`pioneiros/${alunoID}/historico`).remove();
                    setMensagens([]);
                }
            };

            const publicarBiblioteca = () => {
                if (mensagens.length < 2) {
                    alert("Aguarde a resposta do Tutor antes de publicar!");
                    return;
                }
                const titulo = prompt("T√≠tulo para a Biblioteca KhareisBook:");
                if (titulo) {
                    const s_rigor = Number(stats.rigor) || 10;
                    const s_simb = Number(stats.simbiose) || 10;
                    db.ref('mural_publico').push({
                        titulo: titulo, autor: alunoID, data: new Date().toLocaleDateString(),
                        resumo: mensagens[mensagens.length - 1].texto.substring(0, 180) + "...",
                        simbiose: s_simb, rigor: s_rigor, timestamp: Date.now()
                    });
                    alert("Publicado com sucesso na Biblioteca Gold!");
                }
            };

            if (!alunoID) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-[#010409]">
                        <div className="border-oesd p-10 rounded-2xl max-w-md w-full text-center">
                            <h1 className="text-3xl font-bold mb-2 text-[#238636] mono glow-green tracking-tighter uppercase">OESD // Pioneiro</h1>
                            <input value={nomeInput} onChange={e => setNomeInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && setAlunoID(nomeInput.trim())} className="w-full bg-black border border-[#30363d] p-4 rounded-lg my-6 outline-none focus:border-[#238636] text-center text-white" placeholder="Seu Nome ou Pseud√¥nimo"/>
                            <button onClick={() => setAlunoID(nomeInput.trim())} className="w-full bg-[#238636] text-white py-4 rounded-lg font-bold uppercase tracking-widest text-xs hover:bg-[#2ea043]">Acessar Matriz</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-80 bg-[#0d1117] border-r border-[#30363d] p-6 flex flex-col overflow-y-auto chat-scroll">
                        <div className="mb-8">
                            <h1 className="text-xl font-bold text-[#238636] mono">HYPERWEB3</h1>
                            <p className="text-[9px] opacity-40 uppercase tracking-widest">Soberania Epist√™mica</p>
                        </div>

                        <div className="space-y-6">
                            <div><div className="flex justify-between text-[10px] mb-2 font-bold opacity-60 uppercase"><span>Rigor</span><span>{stats.rigor}%</span></div><div className="stats-bar"><div className="stats-fill bg-[#238636]" style={{width: `${stats.rigor}%`}}></div></div></div>
                            <div><div className="flex justify-between text-[10px] mb-2 font-bold opacity-60 uppercase"><span>Imagina√ß√£o</span><span>{stats.imaginacao}%</span></div><div className="stats-bar"><div className="stats-fill bg-[#8957e5]" style={{width: `${stats.imaginacao}%`}}></div></div></div>
                            <div className="pt-6 border-t border-[#30363d] text-center"><span className="text-[10px] opacity-40 block mb-1 uppercase font-bold tracking-widest">Simbiose</span><span className="text-5xl font-bold text-white mono">{stats.simbiose}%</span></div>
                        </div>

                        <div className="mt-8 space-y-3">
                            <a href="manual.html" target="_blank" className="block text-center border border-[#23863650] py-3 rounded text-[10px] font-bold text-[#238636] uppercase hover:bg-[#23863610]">üìñ Manual Acad√™mico</a>
                            <button onClick={() => { 
                                const blob = new Blob([mensagens.map(m => `[${m.autor}]: ${m.texto}`).join('\n\n')], {type: 'text/plain'});
                                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Legado.txt'; a.click();
                            }} className="w-full border border-[#8957e540] py-3 rounded text-[10px] font-bold text-[#8957e5] uppercase hover:bg-[#8957e510]">üìú Exportar Legado</button>
  
<button onClick={publicarBiblioteca} className="w-full border border-[#23863650] py-3 rounded text-[10px] font-bold text-[#238636] uppercase hover:bg-[#23863610] mt-2">
    üåê Publicar na Biblioteca
</button>

<button onClick={limparChat} className="w-full text-[8px] opacity-20 hover:opacity-100 uppercase mt-4 text-red-500 transition-all">
    üóëÔ∏è Limpar Resqu√≠cios
</button>
                            
                        </div>

                        <footer className="mt-auto pt-8 text-center border-t border-[#30363d]">
                            <p className="text-[9px] opacity-30 uppercase tracking-widest mono leading-relaxed">¬© 2025 Carlos Alberto Reis<br/>Propriedade Intelectual Protegida</p>
                            <button onClick={() => { localStorage.clear(); location.reload(); }} className="mt-4 text-[8px] opacity-20 uppercase hover:opacity-100">Sair: {alunoID}</button>
                        </footer>
                    </aside>

                    <main className="flex-1 flex flex-col bg-[#010409]">
                        <div ref={chatRef} className="flex-1 overflow-y-auto p-6 space-y-6 chat-scroll bg-grid">
                            {mensagens.map((m, i) => (
                                <div key={i} className={`flex ${m.autor === 'Tutor' || m.autor === 'SISTEMA' ? 'justify-start' : 'justify-end'}`}>
                                    <div className={`max-w-[85%] p-4 rounded-xl text-sm leading-relaxed border ${m.autor === 'Tutor' ? 'bg-[#0d1117] border-[#30363d] text-[#c9d1d9]' : m.autor === 'SISTEMA' ? 'bg-red-900/10 border-red-500/50 text-red-500 font-bold' : 'bg-[#23863610] border-[#23863640] text-white'}`}>
                                        <span className={`text-[8px] font-bold block mb-2 uppercase tracking-widest mono ${m.autor === 'Tutor' ? 'text-[#8957e5]' : m.autor === 'SISTEMA' ? 'text-red-500' : 'text-[#238636]'}`}>{m.autor}</span>
                                        <div className="whitespace-pre-wrap">{m.texto}</div>
                                    </div>
                                </div>
                            ))}
                            {carregando && <div className="text-[10px] animate-pulse text-[#238636] text-center mono uppercase tracking-widest">Sincronizando com a Matriz...</div>}
                        </div>

                        <div className="p-6 bg-[#0d1117] border-t border-[#30363d]">
                            <div className="max-w-4xl mx-auto flex gap-4">
                                <input value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && enviar()} className="flex-1 bg-black border border-[#30363d] p-4 rounded-xl outline-none focus:border-[#238636] text-sm text-emerald-50" placeholder="Questione, proponha ou co-crie..."/>
                                <button onClick={enviar} disabled={carregando} className="bg-[#238636] text-white px-8 rounded-xl font-bold uppercase text-[10px] tracking-widest disabled:opacity-30">Forjar</button>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
